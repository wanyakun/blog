<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>KVO实现原理 | 坤坤同学</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="KVO实现原理" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="KVO和Notification是Objective-C语言中观察者模式的两种实现机制。KVO指定一个被观察对象，当被观察对象某个属性发生改变时，观察对象会获得通知，你不需要给被观察的对象添加任何额外代码。" />
<meta property="og:description" content="KVO和Notification是Objective-C语言中观察者模式的两种实现机制。KVO指定一个被观察对象，当被观察对象某个属性发生改变时，观察对象会获得通知，你不需要给被观察的对象添加任何额外代码。" />
<link rel="canonical" href="http://localhost:4000/ios/2016/11/12/kvo-principle-of-realization.html" />
<meta property="og:url" content="http://localhost:4000/ios/2016/11/12/kvo-principle-of-realization.html" />
<meta property="og:site_name" content="坤坤同学" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-12T00:41:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="KVO实现原理" />
<script type="application/ld+json">
{"headline":"KVO实现原理","dateModified":"2016-11-12T00:41:00+08:00","datePublished":"2016-11-12T00:41:00+08:00","url":"http://localhost:4000/ios/2016/11/12/kvo-principle-of-realization.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ios/2016/11/12/kvo-principle-of-realization.html"},"description":"KVO和Notification是Objective-C语言中观察者模式的两种实现机制。KVO指定一个被观察对象，当被观察对象某个属性发生改变时，观察对象会获得通知，你不需要给被观察的对象添加任何额外代码。","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="坤坤同学" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">坤坤同学</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">KVO实现原理</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-11-12T00:41:00+08:00" itemprop="datePublished">Nov 12, 2016
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">KVO</a>和Notification是Objective-C语言中<a href="https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">观察者模式</a>的两种实现机制。KVO指定一个被观察对象，当被观察对象某个属性发生改变时，观察对象会获得通知，你不需要给被观察的对象添加任何额外代码。</p>

<h3 id="一什么是kvo">一、什么是KVO</h3>

<p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">KVO</a>和Notification是Objective-C语言中<a href="https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">观察者模式</a>的两种实现机制。KVO指定一个被观察对象，当被观察对象某个属性发生改变时，观察对象会获得通知，你不需要给被观察的对象添加任何额外代码。</p>

<blockquote>
  <p>KVO和Notification区别：KVO是被观察者直接发送消息给观察者，是对象间的交互，而Notification则是观察者和被观察者通过通知中心对象之间进行交互，即消息由被观察者发送到通知中心对象，再由中心对象发给观察者，两者之间并不进行直接的交互。</p>
</blockquote>

<h3 id="二实现原理">二、实现原理</h3>

<p>Apple官方文档描述：</p>

<blockquote>
  <h3 id="key-value-observing-implementation-details">Key-Value Observing Implementation Details</h3>

  <p>Automatic key-value observing is implemented using a technique called <em>isa-swizzling</em>.</p>

  <p>The <code class="language-plaintext highlighter-rouge">isa</code> pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>

  <p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>

  <p>You should never rely on the <code class="language-plaintext highlighter-rouge">isa</code> pointer to determine class membership. Instead, you should use the <code class="language-plaintext highlighter-rouge">class</code> method to determine the class of an object instance.</p>
</blockquote>

<p>从文档中可以看出KVO是通过一项叫做isa-swizzling技术来实现的。当为被观察者属性注册观察者时，被观察者的isa指针被修改，指向一个中间类，而不是真正的类。所以isa指针其实不需要指向实例对象真实的类。我们不要依赖isa指针来确定类成员，相反应该使用类方法来确定实例对象的类。</p>

<p>从网上查到总结如下内容：</p>

<p>当观察某对象时，KVO机制动态创建一个被观察对象类的子类，并为这个新的子类重写了被观察属性keyPath的setter 方法。setter 方法随后负责通知观察对象属性的改变状况。</p>

<h3 id="三使用举例">三、使用举例</h3>

<p>使用KVO分三步：</p>

<ul>
  <li>
    <p>注册观察者:</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addObserver</span><span class="p">:(</span><span class="n">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">forKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">options</span><span class="p">:(</span><span class="n">NSKeyValueObservingOptions</span><span class="p">)</span><span class="nv">options</span> <span class="nf">context</span><span class="p">:(</span><span class="n">nullable</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>观察者中实现</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">observeValueForKeyPath</span><span class="p">:(</span><span class="n">nullable</span> <span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">ofObject</span><span class="p">:(</span><span class="n">nullable</span> <span class="n">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">change</span><span class="p">:(</span><span class="n">nullable</span> <span class="n">NSDictionary</span><span class="o">&lt;</span><span class="n">NSKeyValueChangeKey</span><span class="p">,</span> <span class="n">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">change</span> <span class="nf">context</span><span class="p">:(</span><span class="n">nullable</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>移除观察者</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeObserver</span><span class="p">:(</span><span class="n">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">forKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">context</span><span class="p">:(</span><span class="n">nullable</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span> <span class="n">NS_AVAILABLE</span><span class="p">(</span><span class="mi">10</span><span class="n">_7</span><span class="p">,</span> <span class="mi">5</span><span class="n">_0</span><span class="p">);</span>
    <span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeObserver</span><span class="p">:(</span><span class="n">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">forKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>从以上三步可以看出，使用KVO，不需要对被观察者对象做任何修改。</p>

<ol>
  <li>
    <p>创建一个YKNoteKVOObject类，用于对它属性进行监听</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  YKNoteKVOObject.h</span>
<span class="c1">//  YKNote</span>
<span class="c1">//</span>
<span class="c1">//  Created by wanyakun on 2016/11/3.</span>
<span class="c1">//  Copyright © 2016年 com.ucaiyuan. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">YKNoteKVOObject</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">NSInteger</span> <span class="n">age</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">salary</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">friends</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建一个Controller，添加监听，并打印</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  YKNoteKVOViewController.m</span>
<span class="c1">//  YKNote</span>
<span class="c1">//</span>
<span class="c1">//  Created by wanyakun on 2016/11/7.</span>
<span class="c1">//  Copyright © 2016年 com.ucaiyuan. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import "YKNoteKVOViewController.h"
#import "YKNoteKVOObject.h"
#import "YKNoteRuntimeUtils.h"
#import &lt;objc/runtime.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">YKNoteKVOViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="n">yKNoteKVOObject</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="n">yKNoteKVOObject2</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="n">yKNoteKVOObject3</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="n">yKNoteKVOObject4</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UITextView</span> <span class="o">*</span><span class="n">textView</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">YKNoteKVOViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">// Do any additional setup after loading the view.</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span> <span class="nf">fill</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject"</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject2"</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject3"</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject4"</span><span class="p">;</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">.</span><span class="n">friends</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithCapacity</span><span class="p">:</span><span class="mi">5</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@"========before add observer objective detail========</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addBeforDetailToTextView</span><span class="p">];</span>
       
    <span class="p">[</span><span class="n">self</span> <span class="nf">addObserver</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="s">@"========after add observer objective detail========</span><span class="se">\n</span><span class="s">"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addAfterDetailToTextView</span><span class="p">];</span>
       
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="s">@"============cls supeCls============</span><span class="se">\n</span><span class="s">"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addClsSuperClsToTextView</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="s">@"============Object IMP============</span><span class="se">\n</span><span class="s">"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addObjectIMPToTextView</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="s">@"============Runtime IMP============</span><span class="se">\n</span><span class="s">"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addRuntimeMethodIMPToTextView</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="s">@"============Observer change============</span><span class="se">\n</span><span class="s">"</span><span class="p">];</span>
    <span class="c1">//自动触发KVO通知</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject Change property"</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">setValue</span><span class="p">:</span><span class="s">@"YKNoteKVOObject setValue:forKey:"</span> <span class="nf">forKey</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">setValue</span><span class="p">:</span><span class="s">@"YKNoteKVOObject setValue:forKeyPath:"</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
       
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">mutableArrayValueForKey</span><span class="p">:</span><span class="s">@"friends"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">array</span> <span class="nf">addObject</span><span class="p">:</span><span class="s">@"wanyakun"</span><span class="p">];</span>
    <span class="c1">//手动触发KVO通知</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">.</span><span class="n">salary</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">didReceiveMemoryWarning</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">didReceiveMemoryWarning</span><span class="p">];</span>
    <span class="c1">// Dispose of any resources that can be recreated.</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">removeObserver</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma mark - private method
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addObserver</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"age"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"age"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
       
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"salary"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"friends"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span><span class="o">|</span><span class="n">NSKeyValueObservingOptionOld</span> <span class="n">context</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">removeObserver</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"age"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"age"</span><span class="p">];</span>
       
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"salary"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">removeObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"friends"</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addBeforDetailToTextView</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">beforeDetail</span> <span class="o">=</span>  <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">beforeDetail2</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject2"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">beforeDetail3</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject3"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">beforeDetail4</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject4"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@%@%@%@"</span><span class="p">,</span> <span class="n">beforeDetail</span><span class="p">,</span> <span class="n">beforeDetail2</span><span class="p">,</span> <span class="n">beforeDetail3</span><span class="p">,</span> <span class="n">beforeDetail4</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addAfterDetailToTextView</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">afterDetail</span> <span class="o">=</span>  <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">afterDetail2</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject2"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">afterDetail3</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject3"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">afterDetail4</span> <span class="o">=</span> <span class="p">[</span><span class="n">YKNoteRuntimeUtils</span> <span class="nf">descriptionDetailWithName</span><span class="p">:</span><span class="s">@"yKNoteKVOObject4"</span> <span class="nf">objc</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span><span class="p">];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@%@%@%@"</span><span class="p">,</span> <span class="n">afterDetail</span><span class="p">,</span> <span class="n">afterDetail2</span><span class="p">,</span> <span class="n">afterDetail3</span><span class="p">,</span> <span class="n">afterDetail4</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addClsSuperClsToTextView</span> <span class="p">{</span>
    <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">);</span>
    <span class="n">Class</span> <span class="n">superCls</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"yKNoteKVOObject isa:%@</span><span class="se">\n</span><span class="s">yKNoteKVOObject isa's super class:%@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">superCls</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addObjectIMPToTextView</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">objcIMP</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"objcIMP yKNoteKVOObject setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)],</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setAge</span><span class="p">:)]];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">objcIMP2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"objcIMP yKNoteKVOObject2 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)],</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setAge</span><span class="p">:)]];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">objcIMP3</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"objcIMP yKNoteKVOObject3 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)],</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setAge</span><span class="p">:)]];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">objcIMP4</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"objcIMP yKNoteKVOObject4 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)],</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span> <span class="nf">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">setAge</span><span class="p">:)]];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@%@%@%@"</span><span class="p">,</span> <span class="n">objcIMP</span><span class="p">,</span> <span class="n">objcIMP2</span><span class="p">,</span> <span class="n">objcIMP3</span><span class="p">,</span> <span class="n">objcIMP4</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">addRuntimeMethodIMPToTextView</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">runtimeMethodImpl</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"runtimeMethodImpl yKNoteKVOObject setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)),</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="n">setAge</span><span class="o">:</span><span class="p">))];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">runtimeMethodImpl2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"runtimeMethodImpl yKNoteKVOObject2 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)),</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject2</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="n">setAge</span><span class="o">:</span><span class="p">))];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">runtimeMethodImpl3</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"runtimeMethodImpl yKNoteKVOObject3 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)),</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject3</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="n">setAge</span><span class="o">:</span><span class="p">))];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">runtimeMethodImpl4</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"runtimeMethodImpl yKNoteKVOObject4 setName:%p, setAge:%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">setName</span><span class="p">:)),</span> <span class="n">class_getMethodImplementation</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject4</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="n">setAge</span><span class="o">:</span><span class="p">))];</span>
       
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@%@%@%@"</span><span class="p">,</span> <span class="n">runtimeMethodImpl</span><span class="p">,</span> <span class="n">runtimeMethodImpl2</span><span class="p">,</span> <span class="n">runtimeMethodImpl3</span><span class="p">,</span> <span class="n">runtimeMethodImpl4</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">observeValueForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">ofObject</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">change</span><span class="p">:(</span><span class="n">NSDictionary</span><span class="o">&lt;</span><span class="n">NSKeyValueChangeKey</span><span class="p">,</span><span class="n">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">change</span> <span class="nf">context</span><span class="p">:(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nf">stringByAppendingString</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"The value of %@ change to : %@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">keyPath</span><span class="p">,</span> <span class="p">[</span><span class="n">change</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"new"</span><span class="p">]]];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"The value of %@ change to : %@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">keyPath</span><span class="p">,</span> <span class="p">[</span><span class="n">change</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"new"</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#pragma mark - getter
</span><span class="k">-</span> <span class="p">(</span><span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="p">)</span><span class="n">yKNoteKVOObject</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_yKNoteKVOObject</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_yKNoteKVOObject</span> <span class="o">=</span> <span class="p">[[</span><span class="n">YKNoteKVOObject</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_yKNoteKVOObject</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="p">)</span><span class="n">yKNoteKVOObject2</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_yKNoteKVOObject2</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_yKNoteKVOObject2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">YKNoteKVOObject</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_yKNoteKVOObject2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="p">)</span><span class="n">yKNoteKVOObject3</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_yKNoteKVOObject3</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_yKNoteKVOObject3</span> <span class="o">=</span> <span class="p">[[</span><span class="n">YKNoteKVOObject</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_yKNoteKVOObject3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">YKNoteKVOObject</span> <span class="o">*</span><span class="p">)</span><span class="n">yKNoteKVOObject4</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_yKNoteKVOObject4</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_yKNoteKVOObject4</span> <span class="o">=</span> <span class="p">[[</span><span class="n">YKNoteKVOObject</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_yKNoteKVOObject4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">UITextView</span> <span class="o">*</span><span class="p">)</span><span class="n">textView</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_textView</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_textView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UITextView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
        <span class="n">_textView</span><span class="p">.</span><span class="n">contentOffset</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
        <span class="n">_textView</span><span class="p">.</span><span class="n">editable</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_textView</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>输出的内容</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="o">========</span>before add observer objective <span class="nv">detail</span><span class="o">========</span>
   yKNoteKVOObject:&lt;YKNoteKVOObject: 0x60800024edf0&gt;
   	class YKNoteKVOObject
   	objcClass YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setSalary:,
   		setAge:,
   		age,
   		salary,
   		friends,
   		subObject,
   		setSubObject:,
   		.cxx_destruct,
   		name,
   		setName:,
   		init
   yKNoteKVOObject2:&lt;YKNoteKVOObject: 0x60800024eee0&gt;
   	class YKNoteKVOObject
   	objcClass YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setSalary:,
   		setAge:,
   		age,
   		salary,
   		friends,
   		subObject,
   		setSubObject:,
   		.cxx_destruct,
   		name,
   		setName:,
   		init
   yKNoteKVOObject3:&lt;YKNoteKVOObject: 0x60800005bc30&gt;
   	class YKNoteKVOObject
   	objcClass YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setSalary:,
   		setAge:,
   		age,
   		salary,
   		friends,
   		subObject,
   		setSubObject:,
   		.cxx_destruct,
   		name,
   		setName:,
   		init
   yKNoteKVOObject4:&lt;YKNoteKVOObject: 0x60800024e0d0&gt;
   	class YKNoteKVOObject
   	objcClass YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setSalary:,
   		setAge:,
   		age,
   		salary,
   		friends,
   		subObject,
   		setSubObject:,
   		.cxx_destruct,
   		name,
   		setName:,
   		init
   <span class="o">========</span>after add observer objective <span class="nv">detail</span><span class="o">========</span>
   yKNoteKVOObject:&lt;YKNoteKVOObject: 0x60800024edf0&gt;
   	class YKNoteKVOObject
   	objcClass NSKVONotifying_YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setAge:,
   		setName:,
   		class,
   		dealloc,
   		_isKVOA
   yKNoteKVOObject2:&lt;YKNoteKVOObject: 0x60800024eee0&gt;
   	class YKNoteKVOObject
   	objcClass NSKVONotifying_YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setAge:,
   		setName:,
   		class,
   		dealloc,
   		_isKVOA
   yKNoteKVOObject3:&lt;YKNoteKVOObject: 0x60800005bc30&gt;
   	class YKNoteKVOObject
   	objcClass NSKVONotifying_YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setAge:,
   		setName:,
   		class,
   		dealloc,
   		_isKVOA
   yKNoteKVOObject4:&lt;YKNoteKVOObject: 0x60800024e0d0&gt;
   	class YKNoteKVOObject
   	objcClass YKNoteKVOObject
   	implementmethod 
   		setFriends:,
   		setSalary:,
   		setAge:,
   		age,
   		salary,
   		friends,
   		subObject,
   		setSubObject:,
   		.cxx_destruct,
   		name,
   		setName:,
   		init
   <span class="o">============</span>cls <span class="nv">supeCls</span><span class="o">============</span>
   yKNoteKVOObject isa:NSKVONotifying_YKNoteKVOObject
   yKNoteKVOObject isa<span class="s1">'s super class:YKNoteKVOObject
   ============Object IMP============
   objcIMP yKNoteKVOObject setName:0x1004c145d, setAge:0x1004c7c16
   objcIMP yKNoteKVOObject2 setName:0x1004c145d, setAge:0x1004c7c16
   objcIMP yKNoteKVOObject3 setName:0x1004c145d, setAge:0x1004c7c16
   objcIMP yKNoteKVOObject4 setName:0x1003af810, setAge:0x1003af870
   ============Runtime IMP============
   runtimeMethodImpl yKNoteKVOObject setName:0x1004c145d, setAge:0x1004c7c16
   runtimeMethodImpl yKNoteKVOObject2 setName:0x1004c145d, setAge:0x1004c7c16
   runtimeMethodImpl yKNoteKVOObject3 setName:0x1004c145d, setAge:0x1004c7c16
   runtimeMethodImpl yKNoteKVOObject4 setName:0x1003af810, setAge:0x1003af870
   ============Observer change============
   The value of name change to : YKNoteKVOObject Change property
   The value of name change to : YKNoteKVOObject setValue:forKey:
   The value of name change to : YKNoteKVOObject setValue:forKeyPath:
   The value of friends change to : (
       wanyakun
   )
   The value of salary change to : 1000
</span></code></pre></div>    </div>

    <p>从输出能容可以得出：</p>

    <blockquote>
      <p>class = [objc class],</p>

      <p>objcClass = object_getClass(objc)</p>

      <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Class</span> <span class="nf">object_getClass</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">return</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">getIsa</span><span class="p">();</span>
    <span class="k">else</span> <span class="k">return</span> <span class="n">Nil</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>      </div>
    </blockquote>
  </li>
</ol>

<ul>
  <li>添加observer之前，所有对象的class和objcClass均为YKNoteKVOObject。</li>
  <li>添加observer之后，添加了observer的对象的class为YKNoteKVOObject， objecClass为NSKVONotifying_YKNoteKVOObject
    <ul>
      <li>添加observer之后，对象的isa指针已经被替换为NSKVONotifying_YKNoteKVOObject，为YKNoteKVOObject子类，即动态生成子类（在原类添加前缀NSKVONotifying_），并使用子类替换对象的isa指针。</li>
      <li>子类NSKVONotifying_YKNoteKVOObject重载了被添加了observer的属性的set方法。</li>
    </ul>
  </li>
</ul>

<h3 id="四kvo-compliance">四、KVO Compliance</h3>

<p>官方文档：https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOCompliance.html#//apple_ref/doc/uid/20002178-SW3</p>

<p>其中涉及到到两种技术：自动发射key-value change通知和手动发射key-value change通知</p>

<ul>
  <li>
    <p>自动发射key-value change通知</p>

    <p>NSObject实现了自动发射key-value change通知，使用存取器、KVC方法都会自动发射变化通知，对于集合属性，可以通过代理对象来达到自动发射变化通知。</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Call the accessor method.</span>
<span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@"YKNoteKVOObject Change property"</span><span class="p">;</span>
<span class="c1">// Use setValue:forKey:</span>
<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">setValue</span><span class="p">:</span><span class="s">@"YKNoteKVOObject setValue:forKey:"</span> <span class="nf">forKey</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
<span class="c1">// Use a key path, where 'yKNoteKVOObject' is a kvc-compliant property of 'name'.</span>
<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">setValue</span><span class="p">:</span><span class="s">@"YKNoteKVOObject setValue:forKeyPath:"</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"name"</span><span class="p">];</span>
<span class="c1">// Use mutableArrayValueForKey: to retrieve a relationship proxy object</span>
<span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">yKNoteKVOObject</span> <span class="nf">mutableArrayValueForKey</span><span class="p">:</span><span class="s">@"friends"</span><span class="p">];</span>
<span class="p">[</span><span class="n">array</span> <span class="nf">addObject</span><span class="p">:</span><span class="s">@"wanyakun"</span><span class="p">];</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>手动发射key-value change通知</p>

    <p>手动发射key-value change通知需要实现automaticallyNotifiesObserversForKey:方法。</p>

    <div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 手动实现KVO发射通知，需要重载automaticallyNotifiesObserversForKey:,或者实现automaticallyNotifiesObserversOf&lt;key&gt;, 对于不需要自动发射KVO通知的属性需要返回NO，然后在setter方法中添加willChangeValueForKey:和didChangeValueForKey:方法的调用代码
 */</span>
<span class="k">+</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">automaticallyNotifiesObserversOfSalary</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">automaticallyNotifiesObserversForKey</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">key</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">key</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="s">@"salary"</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">super</span> <span class="nf">automaticallyNotifiesObserversForKey</span><span class="p">:</span><span class="n">key</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setSalary</span><span class="p">:(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">salary</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">willChangeValueForKey</span><span class="p">:</span><span class="s">@"salary"</span><span class="p">];</span>
    <span class="n">_salary</span> <span class="o">=</span> <span class="n">salary</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">didChangeValueForKey</span><span class="p">:</span><span class="s">@"salary"</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="五总结">五、总结</h3>

<p>使用Clang对addObserver代码进行编译，对编译结果代码查看，其中并无NSKVONotifying_YKNoteKVOObject任何代码。更说明，NSKVONotifying_YKNoteKVOObject子类是在runtime时动态生成的。由于这种继承方式的注入是在运行时而不是编译时实现的，如果给定的实例没有观察者，那么KVO不会有任何开销。</p>

  </div><a class="u-url" href="/ios/2016/11/12/kvo-principle-of-realization.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">坤坤同学</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">坤坤同学</li><li><a class="u-email" href="mailto:yakun.wan@gmail.com">yakun.wan@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wanyakun"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wanyakun</span></a></li><li><a href="https://www.twitter.com/wanyakun"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">wanyakun</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>佛系程序员，佛系摄影，佛系户外，佛系健身.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
